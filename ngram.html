<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>N-Gramm Werkstatt</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fira+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
  input[type=range] { -webkit-appearance: none; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.15); outline: none; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #e5c07b; cursor: pointer; border: 2px solid #1a1a2e; }
  button:focus { outline: none; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
var useState = React.useState;
var useRef = React.useRef;
var useEffect = React.useEffect;

var EXPERIMENTS = [
  "Starte mit dem kurzen Text und vergleiche 1-Gramm, 2-Gramm und 3-Gramm. Was fällt auf?",
  "Setze die Temperatur auf 0 und beobachte: Wird immer dasselbe Wort gewählt?",
  "Erhöhe die Temperatur langsam von 0 auf 3. Wie verändert sich die Wahrscheinlichkeitsverteilung?",
  "Klicke auf ein N-Gramm in der Tabelle. Wie oft kommt es im Quelltext vor?",
  "Finde ein N-Gramm das nur einmal vorkommt. Was bedeutet das für die Generierung?",
  "Vergleiche die Häufigkeit von 'ich' als 1-Gramm mit 'ich weiss' als 2-Gramm.",
  "Gib einen Anfangstext ein (z.B. 'Die') und beobachte, wie er die Generierung beeinflusst.",
  "Nutze den langen Text und starte die Auto-Generierung. Ergibt der Text Sinn?",
  "Warum wiederholt sich der generierte Text oft? Experimentiere mit verschiedenen Temperaturen.",
  "Finde heraus: Bei welcher Temperatur ist die Ausgabe am 'kreativsten' aber noch lesbar?",
  "Vergleiche: Wie unterscheidet sich die Generierung bei 2-Gramm vs. 3-Gramm?",
  "Schreibe einen eigenen kurzen Text mit Wiederholungen und beobachte die N-Gramme.",
];

var EXAMPLE_TEXTS = [
  { label: "Kurz", text: "Ich weiss, dass ich nichts weiss. Und wer nichts weiss, der weiss zumindest das. Wer das weiss, weiss mehr als die meisten. Die meisten wissen nicht, dass sie nichts wissen." },
  { label: "Märchen", text: "Es war einmal ein König, der hatte drei Töchter. Die älteste Tochter war klug, die mittlere Tochter war fleißig, und die jüngste Tochter war freundlich. Der König liebte alle drei Töchter sehr. Eines Tages kam ein Drache ins Königreich. Der Drache war groß und gefährlich. Die älteste Tochter hatte eine Idee. Die mittlere Tochter half ihr dabei. Die jüngste Tochter sprach mit dem Drachen. Der Drache war gar nicht böse, er war nur einsam. Die drei Töchter und der Drache wurden Freunde. Der König war sehr stolz auf seine drei Töchter. Von diesem Tag an lebte der Drache im Schloss. Der König, die drei Töchter und der Drache lebten glücklich bis ans Ende ihrer Tage." },
  { label: "Wetter", text: "Das Wetter ist heute schön. Die Sonne scheint und der Himmel ist blau. Morgen wird das Wetter anders. Es wird regnen und der Himmel wird grau sein. Übermorgen scheint wieder die Sonne. Das Wetter ändert sich ständig. Im Sommer ist das Wetter meist warm. Die Sonne scheint oft und lange. Im Winter ist das Wetter kalt. Der Himmel ist oft grau und es schneit. Im Frühling wird das Wetter langsam wärmer. Die Sonne scheint wieder öfter. Im Herbst wird das Wetter kühler. Die Blätter fallen und der Wind weht stark. Das Wetter beeinflusst unsere Stimmung. Bei Sonnenschein sind die Menschen fröhlich. Bei Regen bleiben viele Menschen zu Hause." },
  { label: "Technik", text: "Der Computer ist eine Maschine. Die Maschine verarbeitet Daten. Die Daten werden gespeichert. Der Speicher ist wichtig für den Computer. Ohne Speicher kann der Computer nicht arbeiten. Der Prozessor ist das Herz des Computers. Der Prozessor führt Berechnungen durch. Die Berechnungen sind sehr schnell. Ein moderner Computer kann Milliarden Berechnungen pro Sekunde durchführen. Das Betriebssystem steuert den Computer. Das Betriebssystem verwaltet die Programme. Die Programme werden vom Benutzer gestartet. Der Benutzer gibt Befehle ein. Die Befehle werden vom Computer ausgeführt. Der Computer gibt Ergebnisse aus. Die Ergebnisse erscheinen auf dem Bildschirm. Der Bildschirm zeigt Text und Bilder. Die Bilder bestehen aus Pixeln. Jeder Pixel hat eine Farbe." },
  { label: "Grimm", text: "Es war einmal ein kleines süßes Mädchen, das hatte jedermann lieb, der sie nur ansah, am allerliebsten aber ihre Großmutter, die wusste gar nicht, was sie alles dem Kinde geben sollte. Einmal schenkte sie ihm ein Käppchen von rotem Samt, und weil ihm das so wohl stand, und es nichts anders mehr tragen wollte, hieß es nur das Rotkäppchen. Eines Tages sprach seine Mutter zu ihm: \"Komm, Rotkäppchen, da hast du ein Stück Kuchen und eine Flasche Wein, bring das der Großmutter hinaus; sie ist krank und schwach und wird sich daran laben. Mach dich auf, bevor es heiß wird, und wenn du hinauskommst, so geh hübsch sittsam und lauf nicht vom Wege ab, sonst fällst du und zerbrichst das Glas, und die Großmutter hat nichts. Und wenn du in ihre Stube kommst, so vergiss nicht guten Morgen zu sagen und guck nicht erst in allen Ecken herum!\" \"Ich will schon alles richtig machen,\" sagte Rotkäppchen zur Mutter, und gab ihr die Hand darauf. Die Großmutter aber wohnte draußen im Wald, eine halbe Stunde vom Dorf. Wie nun Rotkäppchen in den Wald kam, begegnete ihm der Wolf. Rotkäppchen aber wusste nicht, was das für ein böses Tier war, und fürchtete sich nicht vor ihm. \"Guten Tag, Rotkäppchen!\" sprach er. \"Schönen Dank, Wolf!\" - \"Wo hinaus so früh, Rotkäppchen?\" - \"Zur Großmutter.\" - \"Was trägst du unter der Schürze?\" - \"Kuchen und Wein. Gestern haben wir gebacken, da soll sich die kranke und schwache Großmutter etwas zugut tun und sich damit stärken.\" - \"Rotkäppchen, wo wohnt deine Großmutter?\" - \"Noch eine gute Viertelstunde weiter im Wald, unter den drei großen Eichbäumen, da steht ihr Haus, unten sind die Nusshecken, das wirst du ja wissen,\" sagte Rotkäppchen. Der Wolf dachte bei sich: Das junge, zarte Ding, das ist ein fetter Bissen, der wird noch besser schmecken als die Alte. Du musst es listig anfangen, damit du beide schnappst. Da ging er ein Weilchen neben Rotkäppchen her, dann sprach er: \"Rotkäppchen, sieh einmal die schönen Blumen, die ringsumher stehen. Warum guckst du dich nicht um? Ich glaube, du hörst gar nicht, wie die Vöglein so lieblich singen? Du gehst ja für dich hin, als wenn du zur Schule gingst, und ist so lustig haussen in dem Wald.\" Rotkäppchen schlug die Augen auf, und als es sah, wie die Sonnenstrahlen durch die Bäume hin und her tanzten und alles voll schöner Blumen stand, dachte es: Wenn ich der Großmutter einen frischen Strauß mitbringe, der wird ihr auch Freude machen; es ist so früh am Tag, dass ich doch zu rechter Zeit ankomme, lief vom Wege ab in den Wald hinein und suchte Blumen. Und wenn es eine gebrochen hatte, meinte es, weiter hinaus stände eine schönere, und lief danach und geriet immer tiefer in den Wald hinein. Der Wolf aber ging geradewegs nach dem Haus der Großmutter und klopfte an die Türe. \"Wer ist draußen?\" - \"Rotkäppchen, das bringt Kuchen und Wein, mach auf!\" - \"Drück nur auf die Klinke!\" rief die Großmutter, \"ich bin zu schwach und kann nicht aufstehen.\" Der Wolf drückte auf die Klinke, die Türe sprang auf und er ging, ohne ein Wort zu sprechen, gerade zum Bett der Großmutter und verschluckte sie. Dann tat er ihre Kleider an, setzte ihre Haube auf, legte sich in ihr Bett und zog die Vorhänge vor. Rotkäppchen aber, war nach den Blumen herumgelaufen, und als es so viel zusammen hatte, dass es keine mehr tragen konnte, fiel ihm die Großmutter wieder ein, und es machte sich auf den Weg zu ihr. Es wunderte sich, dass die Tür aufstand, und wie es in die Stube trat, so kam es ihm so seltsam darin vor, dass es dachte: Ei, du mein Gott, wie ängstlich wird mir's heute zumut, und bin sonst so gerne bei der Großmutter! Es rief: \"Guten Morgen,\" bekam aber keine Antwort. Darauf ging es zum Bett und zog die Vorhänge zurück. Da lag die Großmutter und hatte die Haube tief ins Gesicht gesetzt und sah so wunderlich aus. \"Ei, Großmutter, was hast du für große Ohren!\" - \"Dass ich dich besser hören kann!\" - \"Ei, Großmutter, was hast du für große Augen!\" - \"Dass ich dich besser sehen kann!\" - \"Ei, Großmutter, was hast du für große Hände!\" - \"Dass ich dich besser packen kann!\" - \"Aber, Großmutter, was hast du für ein entsetzlich großes Maul!\" - \"Dass ich dich besser fressen kann!\" Kaum hatte der Wolf das gesagt, so tat er einen Satz aus dem Bette und verschlang das arme Rotkäppchen. Wie der Wolf seinen Appetit gestillt hatte, legte er sich wieder ins Bett, schlief ein und fing an, überlaut zu schnarchen. Der Jäger ging eben an dem Haus vorbei und dachte: Wie die alte Frau schnarcht! Du musst doch sehen, ob ihr etwas fehlt. Da trat er in die Stube, und wie er vor das Bette kam, so sah er, dass der Wolf darin lag. \"Finde ich dich hier, du alter Sünder,\" sagte er, \"ich habe dich lange gesucht.\" Nun wollte er seine Büchse anlegen, da fiel ihm ein, der Wolf könnte die Großmutter gefressen haben und sie wäre noch zu retten, schoss nicht, sondern nahm eine Schere und fing an, dem schlafenden Wolf den Bauch aufzuschneiden. Wie er ein paar Schnitte getan hatte, da sah er das rote Käppchen leuchten, und noch ein paar Schnitte, da sprang das Mädchen heraus und rief: \"Ach, wie war ich erschrocken, wie war's so dunkel in dem Wolf seinem Leib!\" Und dann kam die alte Großmutter auch noch lebendig heraus und konnte kaum atmen. Rotkäppchen aber holte geschwind große Steine, damit füllten sie dem Wolf den Leib, und wie er aufwachte, wollte er fortspringen, aber die Steine waren so schwer, dass er gleich niedersank und sich totfiel. Da waren alle drei vergnügt. Der Jäger zog dem Wolf den Pelz ab und ging damit heim, die Großmutter aß den Kuchen und trank den Wein, den Rotkäppchen gebracht hatte, und erholte sich wieder; Rotkäppchen aber dachte: Du willst dein Lebtag nicht wieder allein vom Wege ab in den Wald laufen, wenn dir's die Mutter verboten hat. Es wird auch erzählt, dass einmal, als Rotkäppchen der alten Großmutter wieder Gebackenes brachte, ein anderer Wolf es angesprochen und vom Wege habe ableiten wollen. Rotkäppchen aber hütete sich und ging geradefort seines Wegs und sagte der Großmutter, dass es dem Wolf begegnet wäre, der ihm guten Tag gewünscht, aber so bös aus den Augen geguckt hätte: \"Wenn's nicht auf offener Straße gewesen wäre, er hätte mich gefressen.\" - \"Komm,\" sagte die Großmutter, \"wir wollen die Türe verschließen, dass er nicht hereinkann.\" Bald danach klopfte der Wolf an und rief: \"Mach auf, Großmutter, ich bin das Rotkäppchen, ich bring dir Gebackenes.\" Sie schwiegen aber und machten die Türe nicht auf. Da schlich der Graukopf etlichemal um das Haus, sprang endlich aufs Dach und wollte warten, bis Rotkäppchen abends nach Hause ginge, dann wollte er ihm nachschleichen und wollt's in der Dunkelheit fressen. Aber die Großmutter merkte, was er im Sinne hatte. Nun stand vor dem Haus ein großer Steintrog, Da sprach sie zu dem Kind: \"Nimm den Eimer, Rotkäppchen, gestern hab ich Würste gekocht, da trag das Wasser, worin sie gekocht sind, in den Trog!\" Rotkäppchen trug so lange, bis der große, große Trog ganz voll war. Da stieg der Geruch von den Würsten dem Wolf in die Nase. Er schnupperte und guckte hinab, endlich machte er den Hals so lang, dass er sich nicht mehr halten konnte, und anfing zu rutschen; so rutschte er vom Dach herab, gerade in den großen Trog hinein und ertrank. Rotkäppchen aber ging fröhlich nach Haus, und von nun an tat ihm niemand mehr etwas zuleide. Es hatte ein Mann einen Esel, der schon lange Jahre die Säcke unverdrossen zur Mühle getragen hatte, dessen Kräfte aber nun zu Ende gingen, so daß er zur Arbeit immer untauglicher ward. Da dachte der Herr daran, ihn aus dem Futter zu schaffen, aber der Esel merkte, daß kein guter Wind wehte, lief fort und machte sich auf den Weg nach Bremen; dort, meinte er, könnte er ja Stadtmusikant werden. Als er ein Weilchen fortgegangen war, fand er einen Jagdhund auf dem Wege liegen, der jappte wie einer, der sich müde gelaufen hat. \"Nun, was jappst du so, Packan?\" fragte der Esel. \"Ach,\" sagte der Hund, \"weil ich alt bin und jeden Tag schwächer werde, auch auf der Jagd nicht mehr fort kann, hat mich mein Herr wollen totschlagen, da hab ich Reißaus genommen; aber womit soll ich nun mein Brot verdienen?\" - \"Weißt du was?\" sprach der Esel, \"ich gehe nach Bremen und werde dort Stadtmusikant, geh mit und laß dich auch bei der Musik annehmen. Ich spiele die Laute und du schlägst die Pauken.\" Der Hund war's zufrieden, und sie gingen weiter. Es dauerte nicht lange, so saß da eine Katze an dem Weg und macht ein Gesicht wie drei Tage Regenwetter. \"Nun, was ist dir in die Quere gekommen, alter Bartputzer?\" sprach der Esel. \"Wer kann da lustig sein, wenn's einem an den Kragen geht,\" antwortete die Katze, \"weil ich nun zu Jahren komme, meine Zähne stumpf werden, und ich lieber hinter dem Ofen sitze und spinne, als nach Mäusen herumjagen, hat mich meine Frau ersäufen wollen; ich habe mich zwar noch fortgemacht, aber nun ist guter Rat teuer: wo soll ich hin?\" - \"Geh mit uns nach Bremen, du verstehst dich doch auf die Nachtmusik, da kannst du ein Stadtmusikant werden.\" Die Katze hielt das für gut und ging mit. Darauf kamen die drei Landesflüchtigen an einem Hof vorbei, da saß auf dem Tor der Haushahn und schrie aus Leibeskräften. \"Du schreist einem durch Mark und Bein,\" sprach der Esel, \"was hast du vor?\" - \"Da hab' ich gut Wetter prophezeit,\" sprach der Hahn, \"weil unserer lieben Frauen Tag ist, wo sie dem Christkindlein die Hemdchen gewaschen hat und sie trocknen will; aber weil morgen zum Sonntag Gäste kommen, so hat die Hausfrau doch kein Erbarmen und hat der Köchin gesagt, sie wollte mich morgen in der Suppe essen, und da soll ich mir heut abend den Kopf abschneiden lassen. Nun schrei ich aus vollem Hals, solang ich kann.\" - \"Ei was, du Rotkopf,\" sagte der Esel, \"zieh lieber mit uns fort, wir gehen nach Bremen, etwas Besseres als den Tod findest du überall; du hast eine gute Stimme, und wenn wir zusammen musizieren, so muß es eine Art haben.\" Der Hahn ließ sich den Vorschlag gefallen, und sie gingen alle vier zusammen fort. Sie konnten aber die Stadt Bremen in einem Tag nicht erreichen und kamen abends in einen Wald, wo sie übernachten wollten. Der Esel und der Hund legten sich unter einen großen Baum, die Katze und der Hahn machten sich in die Äste, der Hahn aber flog bis an die Spitze, wo es am sichersten für ihn war. Ehe er einschlief, sah er sich noch einmal nach allen vier Winden um, da deuchte ihn, er sähe in der Ferne ein Fünkchen brennen, und rief seinen Gesellen zu, es müßte nicht gar weit ein Haus sein, denn es scheine ein Licht. Sprach der Esel: \"So müssen wir uns aufmachen und noch hingehen, denn hier ist die Herberge schlecht.\" Der Hund meinte: \"Ein paar Knochen und etwas Fleisch dran täten ihm auch gut.\" Also machten sie sich auf den Weg nach der Gegend, wo das Licht war, und sahen es bald heller schimmern, und es ward immer größer, bis sie vor ein helles, erleuchtetes Räuberhaus kamen. Der Esel, als der größte, näherte sich dem Fenster und schaute hinein. \"Was siehst du, Grauschimmel?\" fragte der Hahn. \"Was ich sehe?\" antwortete der Esel, \"einen gedeckten Tisch mit schönem Essen und Trinken, und Räuber sitzen daran und lassen's sich wohl sein.\" - \"Das wäre was für uns,\" sprach der Hahn. \"Ja, ja, ach, wären wir da!\" sagte der Esel. Da ratschlagten die Tiere, wie sie es anfangen müßten, um die Räuber hinauszujagen und fanden endlich ein Mittel. Der Esel mußte sich mit den Vorderfüßen auf das Fenster stellen, der Hund auf des Esels Rücken springen, die Katze auf den Hund klettern, und endlich flog der Hahn hinauf, und setzte sich der Katze auf den Kopf. Wie das geschehen war, fingen sie auf ein Zeichen insgesamt an, ihre Musik zu machen: der Esel schrie, der Hund bellte, die Katze miaute und der Hahn krähte. Dann stürzten sie durch das Fenster in die Stube hinein, daß die Scheiben klirrten. Die Räuber fuhren bei dem entsetzlichen Geschrei in die Höhe, meinten nicht anders, als ein Gespenst käme herein, und flohen in größter Furcht in den Wald hinaus. Nun setzten sich die vier Gesellen an den Tisch, nahmen mit dem vorlieb, was übriggeblieben war, und aßen nach Herzenslust. Wie die vier Spielleute fertig waren, löschten sie das Licht aus und suchten sich eine Schlafstelle, jeder nach seiner Natur und Bequemlichkeit. Der Esel legte sich auf den Mist, der Hund hinter die Tür, die Katze auf den Herd bei der warmen Asche, der Hahn setzte sich auf den Hahnenbalken, und weil sie müde waren von ihrem langen Weg, schliefen sie auch bald ein. Als Mitternacht vorbei war und die Räuber von weitem sahen, daß kein Licht mehr im Haus brannte, auch alles ruhig schien, sprach der Hauptmann: \"Wir hätten uns doch nicht sollen ins Bockshorn jagen lassen,\" und hieß einen hingehen und das Haus untersuchen. Der Abgeschickte fand alles still, ging in die Küche, ein Licht anzünden, und weil er die glühenden, feurigen Augen der Katze für lebendige Kohlen ansah, hielt er ein Schwefelhölzchen daran, daß es Feuer fangen sollte. Aber die Katze verstand keinen Spaß, sprang ihm ins Gesicht, spie und kratzte. Da erschrak er gewaltig, lief und wollte zur Hintertüre hinaus, aber der Hund, der da lag, sprang auf und biß ihn ins Bein, und als er über den Hof an dem Miste vorbeikam, gab ihm der Esel noch einen tüchtigen Schlag mit dem Hinterfuß; der Hahn aber, der vom Lärmen aus dem Schlaf geweckt und munter geworden war, rief vom Balken herab: \"Kikeriki!\" Da lief der Räuber, was er konnte, zu seinem Hauptmann zurück und sprach: \"Ach, in dem Haus sitzt eine greuliche Hexe, die hat mich angehaucht und mit ihren langen Fingern mir das Gesicht zerkratzt. Und vor der Tür steht ein Mann mit einem Messer, der hat mich ins Bein gestochen. Und auf dem Hof liegt ein schwarzes Ungetüm, das hat mit einer Holzkeule auf mich losgeschlagen. Und oben auf dem Dache, da sitzt der Richter, der rief: 'Bringt mir den Schelm her!' Da machte ich, daß ich fortkam.\" Von nun an getrauten sich die Räuber nicht weiter in das Haus, den vier Bremer Musikanten gefiel's aber so wohl darin, daß sie nicht wieder heraus wollten." }
];
var PUNCT = new Set([".", ",", "!", "?", ";", ":"]);
var SAMPLING_SLOTS = 8;
var MAX_STEPS = 60;

function tokenize(text) {
  return text.replace(/([.!?,;:])/g, " $1").split(/\s+/).filter(function(t) { return t.length > 0; });
}
function detokenize(tokens) {
  var out = "";
  for (var i = 0; i < tokens.length; i++) {
    if (i > 0 && !PUNCT.has(tokens[i])) out += " ";
    out += tokens[i];
  }
  return out;
}
function buildNgrams(tokens, n) {
  var map = new Map();
  for (var i = 0; i <= tokens.length - n; i++) {
    var key = tokens.slice(i, i + n).join(" ");
    map.set(key, (map.get(key) || 0) + 1);
  }
  var entries = Array.from(map.entries());
  entries.sort(function(a, b) { return b[1] - a[1]; });
  return entries.map(function(e) { return { gram: e[0], count: e[1] }; });
}
function getCandidates(tokens, n, context) {
  var freq = new Map();
  if (n === 1) {
    for (var i = 0; i < tokens.length; i++) freq.set(tokens[i], (freq.get(tokens[i]) || 0) + 1);
  } else {
    for (var i = 0; i <= tokens.length - n; i++) {
      var ctx = tokens.slice(i, i + n - 1).join(" ");
      if (ctx === context) { var next = tokens[i + n - 1]; freq.set(next, (freq.get(next) || 0) + 1); }
    }
  }
  var entries = Array.from(freq.entries());
  entries.sort(function(a, b) { return b[1] - a[1]; });
  return entries.map(function(e) { return { word: e[0], count: e[1] }; });
}
function applyTemperature(candidates, temperature) {
  if (candidates.length === 0) return [];
  var total = 0;
  for (var i = 0; i < candidates.length; i++) total += candidates[i].count;
  // Temperatur 0 behandeln wir als sehr kleine Zahl (verhindert Division durch 0)
  var temp = Math.max(temperature, 0.001);
  var logProbs = candidates.map(function(c) { return Math.log(c.count / total) / temp; });
  var ml = logProbs[0];
  for (var i = 1; i < logProbs.length; i++) { if (logProbs[i] > ml) ml = logProbs[i]; }
  var es = 0;
  var exps = logProbs.map(function(lp) { var e = Math.exp(lp - ml); es += e; return e; });
  return candidates.map(function(c, i) { return { word: c.word, count: c.count, prob: exps[i] / es }; });
}
// Sampelt ein Wort aus der Verteilung (zufällig, gewichtet nach Wahrscheinlichkeit)
function sampleWord(dist) {
  var r = Math.random(), cumulative = 0;
  for (var i = 0; i < dist.length; i++) {
    cumulative += dist[i].prob;
    if (r < cumulative) return dist[i].word;
  }
  return dist[dist.length - 1].word;
}
function getAllContexts(tokens, n) {
  var s = new Set();
  for (var i = 0; i <= tokens.length - n; i++) s.add(tokens.slice(i, i + n - 1).join(" "));
  return Array.from(s);
}
function makeGramKey(n, context, word) {
  if (n === 1) return word;
  return context.split(" ").concat([word]).join(" ");
}

// Findet alle Positionen eines N-Gramms im Token-Array
function findNgramPositions(tokens, gramTokens) {
  var positions = [];
  var n = gramTokens.length;
  for (var i = 0; i <= tokens.length - n; i++) {
    var match = true;
    for (var j = 0; j < n; j++) {
      if (tokens[i + j] !== gramTokens[j]) { match = false; break; }
    }
    if (match) positions.push(i);
  }
  return positions;
}

function NgramRow(props) {
  var display = detokenize(props.gram.split(" "));
  var hl = props.highlight || props.clickHighlight;
  var col = props.clickHighlight ? props.clickColor || props.color : props.color;
  var relFreq = props.totalCount > 0 ? ((props.count / props.totalCount) * 100).toFixed(1) : "0.0";
  return (
    <tr data-gram={props.gram} onClick={props.onClick} style={{
      background: hl ? col + "25" : "transparent",
      transition: "background 0.3s",
      cursor: "pointer",
    }}>
      <td style={{
        padding: "6px 12px",
        fontFamily: "'Fira Mono', monospace",
        fontSize: 13,
        fontWeight: hl ? 700 : 400,
        color: hl ? col : "rgba(255,255,255,0.8)",
        borderBottom: "1px solid rgba(255,255,255,0.05)",
      }}>{display}</td>
      <td style={{
        padding: "6px 12px",
        fontFamily: "'Fira Mono', monospace",
        fontSize: 13,
        textAlign: "right",
        color: hl ? col : "rgba(255,255,255,0.6)",
        borderBottom: "1px solid rgba(255,255,255,0.05)",
      }}>{props.count}</td>
      <td style={{
        padding: "6px 12px",
        fontFamily: "'Fira Mono', monospace",
        fontSize: 13,
        textAlign: "right",
        color: hl ? col : "rgba(255,255,255,0.5)",
        borderBottom: "1px solid rgba(255,255,255,0.05)",
      }}>{relFreq}%</td>
    </tr>
  );
}

function SamplingViz(props) {
  var dist = props.distribution;
  var picked = props.picked;
  var context = props.context;
  var n = props.n;
  var color = props.color;
  var stepNum = props.stepNum;
  var totalSteps = props.totalSteps;
  var onCandidateClick = props.onCandidateClick;
  var slots = [], hidden = 0;
  if (dist && dist.length > 0) { slots = dist.slice(0, SAMPLING_SLOTS); hidden = dist.length - slots.length; }
  var maxProb = 0;
  for (var i = 0; i < slots.length; i++) { if (slots[i].prob > maxProb) maxProb = slots[i].prob; }
  var empty = SAMPLING_SLOTS - slots.length;
  var noData = !dist || dist.length === 0;

  return (
    <div style={{ background: "rgba(0,0,0,0.25)", border: "1px solid rgba(255,255,255,0.08)", borderRadius: 14, padding: 16 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10, minHeight: 18 }}>
        <div style={{ fontSize: 12, opacity: 0.6 }}>
          {noData ? "Warte auf Generator ..." : (
            <span>
              {n === 1 ? "Kontext: (keiner)" : "Kontext: "}
              {n > 1 && <span style={{ fontFamily: "'Fira Mono', monospace", color: color, fontWeight: 700 }}>{detokenize(context.split(" "))}</span>}
              <span style={{ marginLeft: 8, opacity: 0.6 }}>{dist.length} Kandidat{dist.length !== 1 ? "en" : ""}</span>
            </span>
          )}
        </div>
        {totalSteps > 0 && <div style={{ fontSize: 11, opacity: 0.4, fontFamily: "'Fira Mono', monospace" }}>Schritt {stepNum} / {totalSteps}</div>}
      </div>
      {slots.map(function(item, i) {
        var ip = item.word === picked;
        var bw = maxProb > 0 ? Math.max(2, (item.prob / maxProb) * 100) : 0;
        var pct = (item.prob * 100).toFixed(1);
        return (
          <div key={item.word + "-" + i}
            onClick={function() { if (onCandidateClick) onCandidateClick(item.word, context); }}
            style={{
              display: "flex", alignItems: "center", gap: 8, height: 26, padding: "0 6px",
              borderRadius: 6, cursor: onCandidateClick ? "pointer" : "default",
              background: ip ? color + "25" : "transparent", transition: "background 0.3s",
            }}>
            <div style={{ width: 90, fontFamily: "'Fira Mono', monospace", fontSize: 13, fontWeight: ip ? 700 : 400, color: ip ? color : "rgba(255,255,255,0.7)", textAlign: "right", flexShrink: 0, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{item.word}</div>
            <div style={{ flex: 1, height: 14, background: "rgba(255,255,255,0.05)", borderRadius: 3, overflow: "hidden" }}>
              <div style={{ height: "100%", borderRadius: 3, width: bw + "%", background: ip ? "linear-gradient(90deg, " + color + ", " + color + "cc)" : "rgba(255,255,255,0.15)", transition: "width 0.3s, background 0.3s" }} />
            </div>
            <div style={{ width: 44, fontSize: 11, fontFamily: "'Fira Mono', monospace", textAlign: "right", color: ip ? color : "rgba(255,255,255,0.4)", flexShrink: 0, fontWeight: ip ? 700 : 400 }}>{pct}%</div>
            <div style={{ width: 14, fontSize: 11, flexShrink: 0, textAlign: "center", color: ip ? color : "transparent" }}>{ip ? "\u25C0" : ""}</div>
          </div>
        );
      })}
      {Array.from({ length: empty }).map(function(_, i) {
        return (
          <div key={"e" + i} style={{ display: "flex", alignItems: "center", gap: 8, height: 26, padding: "0 6px", opacity: 0.15 }}>
            <div style={{ width: 90, textAlign: "right", fontSize: 13 }}>{"\u2014"}</div>
            <div style={{ flex: 1, height: 14, background: "rgba(255,255,255,0.05)", borderRadius: 3 }} />
            <div style={{ width: 44 }} /><div style={{ width: 14 }} />
          </div>
        );
      })}
      {hidden > 0 && <div style={{ fontSize: 11, opacity: 0.35, marginTop: 4, textAlign: "center" }}>+ {hidden} weitere</div>}
    </div>
  );
}

function NGramApp() {
  var _s = useState(EXAMPLE_TEXTS[0].text); var inputText = _s[0], setInputText = _s[1];
  var _n = useState(1); var activeN = _n[0], setActiveN = _n[1];
  var _p = useState(""); var prompt = _p[0], setPrompt = _p[1];
  var _t = useState(0); var temperature = _t[0], setTemperature = _t[1];
  var _tick = useState(0); var tick = _tick[0], setTick = _tick[1];
  var _cg = useState(null); var clickedGram = _cg[0], setClickedGram = _cg[1];
  var _exp = useState(false); var showExperiments = _exp[0], setShowExperiments = _exp[1];

  // Historie: jeder Schritt = { textWords, distribution, picked, context, highlightGram }
  // textWords = bisher generierte Wörter (picked noch nicht enthalten)
  // distribution/picked = Sampling für das NÄCHSTE Wort
  var histRef = useRef([]);
  var viewRef = useRef(-1);
  var activeRef = useRef(false);
  var autoRef = useRef(null);
  var autoOnRef = useRef(false);
  var outputRef = useRef(null);
  var ngramBoxRef = useRef(null);
  var liveStepRef = useRef(null);  // Speichert den aktuell angezeigten Step

  function rerender() { setTick(function(t) { return t + 1; }); }

  var tokens = tokenize(inputText);
  var ngrams = buildNgrams(tokens, activeN);
  var tabs = [
    { n: 1, label: "1-Gramm", color: "#e06c75" },
    { n: 2, label: "2-Gramm", color: "#61afef" },
    { n: 3, label: "3-Gramm", color: "#98c379" },
  ];
  var at = tabs.find(function(t) { return t.n === activeN; });
  var color = at ? at.color : "#61afef";

  var hist = histRef.current;
  var vi = viewRef.current;
  var storedStep = vi >= 0 && vi < hist.length ? hist[vi] : null;
  var isActive = activeRef.current;
  var atLatest = vi === hist.length - 1;
  var isDone = isActive && hist.length > 0 && hist.length >= MAX_STEPS;

  // Live-Berechnung: Bei Temperaturänderung Distribution neu berechnen (nur am aktuellen Schritt)
  var step = storedStep;
  if (storedStep && atLatest && storedStep.context !== null) {
    var cands = getCandidates(tokens, activeN, storedStep.context);
    if (cands.length > 0) {
      var liveDist = applyTemperature(cands, temperature);
      var livePicked = sampleWord(liveDist);
      var liveHg = makeGramKey(activeN, storedStep.context, livePicked);
      step = { textWords: storedStep.textWords, distribution: liveDist, picked: livePicked, context: storedStep.context, highlightGram: liveHg };
    }
  }
  liveStepRef.current = step;  // Speichern für advanceOneStep

  var displayWords = step ? step.textWords : [];
  var highlightGram = step ? step.highlightGram : null;
  var canFwd = isActive ? (!atLatest || !isDone) : true;
  var canBack = vi > 0;

  function stopAuto() {
    autoOnRef.current = false;
    if (autoRef.current) { clearTimeout(autoRef.current); autoRef.current = null; }
  }

  function resetGen() {
    stopAuto();
    histRef.current = []; viewRef.current = -1; activeRef.current = false;
    setClickedGram(null);
    rerender();
  }

  function makeStep(textWords, context, n, temp) {
    var cands = getCandidates(tokens, n, context);
    if (cands.length === 0) return { textWords: textWords, distribution: null, picked: null, context: context, highlightGram: null };
    var dist = applyTemperature(cands, temp);
    var picked = sampleWord(dist);
    var hg = makeGramKey(n, context, picked);
    return { textWords: textWords, distribution: dist, picked: picked, context: context, highlightGram: hg };
  }

  function initGen() {
    var n = activeN; var temp = temperature;
    var ctxs = n === 1 ? [""] : getAllContexts(tokens, n);
    if (ctxs.length === 0) return false;
    var pt = tokenize(prompt.trim());
    var result, context;
    if (n === 1) { result = pt.length > 0 ? pt.slice() : []; context = ""; }
    else if (pt.length >= n - 1) {
      result = pt.slice(); context = pt.slice(-(n - 1)).join(" ");
      if (ctxs.indexOf(context) < 0) { context = ctxs[0]; result = pt.concat(context.split(" ")); }
    } else if (pt.length > 0) {
      var lw = pt[pt.length - 1].toLowerCase();
      var m = ctxs.filter(function(k) { return k.toLowerCase().indexOf(lw) >= 0; });
      if (m.length > 0) { context = m[0]; result = pt.slice(); var ct = context.split(" "); for (var i = 1; i < ct.length; i++) result.push(ct[i]); }
      else { context = ctxs[0]; result = pt.concat(context.split(" ")); }
    } else { context = n === 1 ? "" : ctxs[0]; result = n === 1 ? [] : context.split(" "); }

    var s = makeStep(result, context, n, temp);
    histRef.current = [s];
    viewRef.current = 0;
    activeRef.current = true;
    setClickedGram(null);
    rerender();
    return true;
  }

  function advanceOneStep() {
    var h = histRef.current;
    if (h.length >= MAX_STEPS) return false;
    var n = activeN;

    // Verwende das angezeigte picked (aus liveStepRef)
    var live = liveStepRef.current;
    if (!live || !live.picked) return false;
    var picked = live.picked;

    // Neuer Text mit picked
    var newWords = live.textWords.concat([picked]);

    // Neuer Kontext
    var newCtx = "";
    if (n > 1) {
      var cw = live.context.split(" ").concat([picked]);
      if (cw.length > n - 1) cw.shift();
      newCtx = cw.join(" ");
    }

    h.push(makeStep(newWords, newCtx, n, temperature));
    viewRef.current = h.length - 1;
    setClickedGram(null);
    rerender();
    return true;
  }

  function stepForward() {
    if (!activeRef.current) { initGen(); return; }
    if (viewRef.current < histRef.current.length - 1) {
      viewRef.current = viewRef.current + 1; setClickedGram(null); rerender(); return;
    }
    advanceOneStep();
  }

  function stepBack() {
    if (viewRef.current > 0) { viewRef.current = viewRef.current - 1; setClickedGram(null); rerender(); }
  }

  function toggleAuto() {
    if (autoOnRef.current) { stopAuto(); rerender(); return; }
    if (!activeRef.current) { if (!initGen()) return; }
    autoOnRef.current = true; rerender();
    function doTick() {
      if (!autoOnRef.current) return;
      if (viewRef.current < histRef.current.length - 1) {
        viewRef.current = viewRef.current + 1; setClickedGram(null); rerender();
      } else {
        var ok = advanceOneStep();
        if (!ok) { stopAuto(); rerender(); return; }
      }
      autoRef.current = setTimeout(doTick, 700);
    }
    autoRef.current = setTimeout(doTick, 300);
  }

  function handleCandidateClick(word, context) {
    var gram = makeGramKey(activeN, context, word);
    setClickedGram(gram);
    // Scroll zur passenden Tabellenzeile
    if (ngramBoxRef.current) {
      var el = ngramBoxRef.current.querySelector('[data-gram="' + gram + '"]');
      if (el) el.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  }

  useEffect(function() {
    function handleKey(e) {
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
      if (e.code === "ArrowRight" || e.code === "Space") { e.preventDefault(); if (!autoOnRef.current) stepForward(); }
      else if (e.code === "ArrowLeft") { e.preventDefault(); if (!autoOnRef.current) stepBack(); }
      else if (e.code === "Escape") { stopAuto(); rerender(); }
    }
    window.addEventListener("keydown", handleKey);
    return function() { window.removeEventListener("keydown", handleKey); };
  });
  useEffect(function() { if (outputRef.current) outputRef.current.scrollTop = outputRef.current.scrollHeight; }, [tick]);
  useEffect(function() { return function() { stopAuto(); }; }, []);

  var tempLabel = temperature < 0.3 ? "Wenig Zufall" : temperature < 1.2 ? "Normal" : temperature < 2.0 ? "Viel Zufall" : "Chaotisch";
  var autoOn = autoOnRef.current;

  return (
    <div style={{ color: "#e0e0e0", fontFamily: "'Nunito', sans-serif", padding: "24px 16px", maxWidth: 800, margin: "0 auto" }}>
      <div style={{ textAlign: "center", marginBottom: 28 }}>
        <h1 style={{ fontSize: 32, fontWeight: 900, margin: 0, background: "linear-gradient(90deg, #e06c75, #61afef, #98c379)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>N-Gramm Werkstatt</h1>
        <p style={{ fontSize: 14, opacity: 0.5, margin: "6px 0 0" }}>Wortmuster · Sampling · Temperatur</p>
        <button onClick={function() { setShowExperiments(!showExperiments); }}
          style={{ marginTop: 12, padding: "6px 14px", borderRadius: 8, border: "1px solid rgba(255,255,255,0.2)", background: showExperiments ? "rgba(255,255,255,0.1)" : "transparent", color: "rgba(255,255,255,0.7)", fontSize: 12, cursor: "pointer" }}>
          {showExperiments ? "▼ Experimente ausblenden" : "▶ Experimente zum Ausprobieren"}
        </button>
      </div>

      {showExperiments && (
        <div style={{ marginBottom: 24, padding: 16, borderRadius: 12, background: "rgba(255,255,255,0.03)", border: "1px solid rgba(255,255,255,0.08)" }}>
          <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, opacity: 0.7 }}>Ideen zum Experimentieren:</div>
          <ol style={{ margin: 0, paddingLeft: 20, fontSize: 13, lineHeight: 1.8, color: "rgba(255,255,255,0.7)" }}>
            {EXPERIMENTS.map(function(exp, i) {
              return <li key={i} style={{ marginBottom: 4 }}>{exp}</li>;
            })}
          </ol>
        </div>
      )}

      <div style={{ marginBottom: 24 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
          <label style={{ fontSize: 13, fontWeight: 700, opacity: 0.7 }}>Quelltext</label>
          <div style={{ display: "flex", gap: 4 }}>
            {EXAMPLE_TEXTS.map(function(ex, i) {
              return <button key={i} onClick={function() { setInputText(ex.text); resetGen(); }}
                style={{ padding: "3px 8px", borderRadius: 6, border: "1px solid rgba(255,255,255,0.15)", background: "rgba(0,0,0,0.3)", color: "rgba(255,255,255,0.6)", fontSize: 11, cursor: "pointer" }}>{ex.label}</button>;
            })}
          </div>
        </div>
        <textarea value={inputText} onChange={function(e) { setInputText(e.target.value); resetGen(); }} rows={4}
          style={{ width: "100%", boxSizing: "border-box", padding: 14, borderRadius: 12, border: "1px solid rgba(255,255,255,0.12)", background: "rgba(0,0,0,0.3)", color: "#e0e0e0", fontFamily: "'Fira Mono', monospace", fontSize: 13, lineHeight: 1.6, resize: "vertical", outline: "none" }} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 4 }}>
          <div style={{ fontSize: 12, opacity: 0.4 }}>{tokens.length} Wörter</div>
          {clickedGram && <button onClick={function() { setClickedGram(null); }} style={{ fontSize: 11, padding: "2px 8px", borderRadius: 4, border: "1px solid rgba(255,255,255,0.15)", background: "transparent", color: "rgba(255,255,255,0.5)", cursor: "pointer" }}>Markierung aufheben</button>}
        </div>
        {clickedGram && (function() {
          var gramTokens = clickedGram.split(" ");
          var positions = findNgramPositions(tokens, gramTokens);
          var highlighted = new Set();
          positions.forEach(function(pos) {
            for (var i = 0; i < gramTokens.length; i++) highlighted.add(pos + i);
          });
          return (
            <div style={{ marginTop: 8, padding: 12, borderRadius: 10, background: "rgba(229,192,123,0.08)", border: "1px solid rgba(229,192,123,0.2)", fontFamily: "'Fira Mono', monospace", fontSize: 13, lineHeight: 1.8 }}>
              {tokens.map(function(token, i) {
                var isHl = highlighted.has(i);
                var sp = i > 0 && !PUNCT.has(token);
                return (
                  <span key={i}>
                    {sp && " "}
                    <span style={{ background: isHl ? "rgba(229,192,123,0.4)" : "transparent", padding: isHl ? "2px 4px" : 0, borderRadius: 4, fontWeight: isHl ? 700 : 400, color: isHl ? "#e5c07b" : "rgba(255,255,255,0.7)" }}>{token}</span>
                  </span>
                );
              })}
              <div style={{ fontSize: 11, opacity: 0.5, marginTop: 8 }}>{positions.length} Vorkommen von "{detokenize(gramTokens)}"</div>
            </div>
          );
        })()}
      </div>

      <div style={{ marginBottom: 24 }}>
        <div style={{ display: "flex", gap: 4, marginBottom: 16 }}>
          {tabs.map(function(tab) {
            var isCur = activeN === tab.n;
            return (
              <button key={tab.n} onClick={function() { if (!autoOn) { setActiveN(tab.n); resetGen(); } }} disabled={autoOn}
                style={{ flex: 1, padding: "10px 8px", border: "none", borderRadius: 10, fontFamily: "'Nunito', sans-serif", fontWeight: isCur ? 800 : 600, fontSize: 15, cursor: autoOn ? "not-allowed" : "pointer", background: isCur ? tab.color : "rgba(255,255,255,0.06)", color: isCur ? "#fff" : "rgba(255,255,255,0.5)", transition: "all 0.25s", boxShadow: isCur ? "0 4px 20px " + tab.color + "50" : "none", opacity: autoOn && !isCur ? 0.4 : 1 }}>{tab.label}</button>
            );
          })}
        </div>
        <div ref={ngramBoxRef} style={{ background: "rgba(0,0,0,0.25)", border: "1px solid rgba(255,255,255,0.08)", borderRadius: 14, padding: 0, maxHeight: 200, overflowY: "auto" }}>
          {ngrams.length === 0 ? (
            <div style={{ textAlign: "center", opacity: 0.4, padding: 20, fontSize: 13 }}>Text eingeben, um N-Gramme zu sehen.</div>
          ) : (
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
              <thead>
                <tr style={{ position: "sticky", top: 0, background: "rgba(30,30,50,0.95)", zIndex: 1 }}>
                  <th style={{ padding: "10px 12px", textAlign: "left", fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.5)", borderBottom: "1px solid rgba(255,255,255,0.1)", textTransform: "uppercase", letterSpacing: "0.5px" }}>N-Gramm</th>
                  <th style={{ padding: "10px 12px", textAlign: "right", fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.5)", borderBottom: "1px solid rgba(255,255,255,0.1)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Anzahl</th>
                  <th style={{ padding: "10px 12px", textAlign: "right", fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.5)", borderBottom: "1px solid rgba(255,255,255,0.1)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Häufigkeit</th>
                </tr>
              </thead>
              <tbody>
                {(function() {
                  var totalCount = tokens.length - activeN + 1;
                  return ngrams.map(function(ng) {
                    return <NgramRow key={ng.gram} gram={ng.gram} count={ng.count} totalCount={totalCount}
                      highlight={highlightGram === ng.gram}
                      clickHighlight={clickedGram === ng.gram}
                      clickColor={"#e5c07b"}
                      color={color}
                      onClick={function() { setClickedGram(clickedGram === ng.gram ? null : ng.gram); }} />;
                  });
                })()}
              </tbody>
            </table>
          )}
        </div>
        <div style={{ fontSize: 12, opacity: 0.4, marginTop: 6 }}>{ngrams.length} verschiedene {activeN}-Gramme</div>
      </div>

      <div style={{ marginBottom: 24 }}>
        <div style={{ marginBottom: 14, padding: 14, borderRadius: 12, background: "rgba(229,192,123,0.06)", border: "1px solid rgba(229,192,123,0.15)" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
            <label style={{ fontSize: 13, fontWeight: 700, color: "#e5c07b" }}>Temperatur</label>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <span style={{ fontSize: 12, opacity: 0.6, color: "#e5c07b" }}>{tempLabel}</span>
              <span style={{ fontFamily: "'Fira Mono', monospace", fontSize: 14, fontWeight: 700, color: "#e5c07b" }}>{temperature.toFixed(2)}</span>
            </div>
          </div>
          <input type="range" min="0" max="3" step="0.05" value={temperature} onChange={function(e) { setTemperature(parseFloat(e.target.value)); }} disabled={autoOn} style={{ width: "100%", margin: 0 }} />
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 4 }}>
            <span style={{ fontSize: 11, opacity: 0.35 }}>0 = vorhersagbar</span>
            <span style={{ fontSize: 11, opacity: 0.35 }}>3 = chaotisch</span>
          </div>
        </div>

        <div style={{ marginBottom: 12 }}>
          <input type="text" value={prompt} onChange={function(e) { setPrompt(e.target.value); }} placeholder="Anfangstext (optional)" disabled={isActive}
            style={{ width: "100%", boxSizing: "border-box", padding: "10px 14px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.12)", background: isActive ? "rgba(0,0,0,0.15)" : "rgba(0,0,0,0.25)", color: isActive ? "rgba(255,255,255,0.4)" : "#e0e0e0", fontFamily: "'Fira Mono', monospace", fontSize: 13, outline: "none" }} />
          <div style={{ fontSize: 11, opacity: 0.35, marginTop: 4 }}>Vorgabe, die der Computer fortführt</div>
        </div>

        <div style={{ display: "flex", gap: 6, marginBottom: 14, flexWrap: "wrap", alignItems: "center" }}>
          <button onClick={function() { if (!autoOn) stepBack(); }} disabled={!canBack || autoOn}
            style={{ padding: "9px 14px", borderRadius: 10, border: "none", fontWeight: 700, fontSize: 18, cursor: canBack && !autoOn ? "pointer" : "not-allowed", background: canBack && !autoOn ? "rgba(255,255,255,0.1)" : "rgba(255,255,255,0.03)", color: canBack && !autoOn ? "rgba(255,255,255,0.8)" : "rgba(255,255,255,0.2)", transition: "all 0.2s", lineHeight: 1 }}>{"\u25C0"}</button>

          <button onClick={function() { if (!autoOn) stepForward(); }} disabled={autoOn || (isActive && !canFwd)}
            style={{ padding: "9px 20px", borderRadius: 10, border: "none", fontFamily: "'Nunito', sans-serif", fontWeight: 800, fontSize: 14, cursor: autoOn || (isActive && !canFwd) ? "not-allowed" : "pointer", background: !isActive ? "linear-gradient(135deg, #98c379, #7fb86a)" : "linear-gradient(135deg, " + color + ", " + color + "cc)", color: "#fff", boxShadow: "0 3px 14px rgba(0,0,0,0.3)", transition: "all 0.2s" }}>
            {!isActive ? "Start" : atLatest ? "Nächstes Wort \u25B6" : "Vorwärts \u25B6"}
          </button>

          <button onClick={toggleAuto} disabled={isDone && !autoOn}
            style={{ padding: "9px 16px", borderRadius: 10, border: "none", fontFamily: "'Nunito', sans-serif", fontWeight: 700, fontSize: 13, cursor: isDone && !autoOn ? "not-allowed" : "pointer", background: autoOn ? "linear-gradient(135deg, #e06c75, #be5046)" : "rgba(255,255,255,0.08)", color: autoOn ? "#fff" : "rgba(255,255,255,0.6)", transition: "all 0.2s" }}>
            {autoOn ? "Stopp" : "Auto \u25B6\u25B6"}
          </button>

          <button onClick={resetGen}
            style={{ padding: "9px 14px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.12)", background: "transparent", color: "rgba(255,255,255,0.5)", fontFamily: "'Nunito', sans-serif", fontWeight: 600, fontSize: 13, cursor: "pointer" }}>
            {"\u21BB"} Zurücksetzen
          </button>

          {isActive && <span style={{ fontSize: 11, opacity: 0.3, marginLeft: 4, fontFamily: "'Fira Mono', monospace" }}>Leertaste / Pfeiltasten</span>}
        </div>

        <div ref={outputRef} style={{ background: "rgba(0,0,0,0.35)", border: "2px solid " + (isActive ? color + "40" : "rgba(255,255,255,0.08)"), borderRadius: 14, padding: 18, minHeight: 70, maxHeight: 180, overflowY: "auto", transition: "border-color 0.3s" }}>
          {displayWords.length === 0 && !isActive ? (
            <div style={{ opacity: 0.3, fontSize: 13, textAlign: "center" }}>Drücke Start oder Leertaste ...</div>
          ) : displayWords.length === 0 && isActive ? (
            <div style={{ opacity: 0.3, fontSize: 13, textAlign: "center" }}>Drücke Nächstes Wort ...</div>
          ) : (
            <div style={{ fontFamily: "'Fira Mono', monospace", fontSize: 14, lineHeight: 1.8 }}>
              {displayWords.map(function(word, i) {
                var sp = i > 0 && !PUNCT.has(word);
                return (
                  <span key={i}>
                    {sp && " "}
                    <span style={{ padding: "2px 2px", borderRadius: 4 }}>{word}</span>
                  </span>
                );
              })}
              {isActive && atLatest && !isDone && (
                <span style={{ display: "inline-block", width: 8, height: 18, marginLeft: 3, background: color, borderRadius: 2, verticalAlign: "text-bottom", animation: "blink 0.8s infinite" }} />
              )}
            </div>
          )}
        </div>
      </div>

      <div style={{ marginBottom: 24 }}>
        <label style={{ display: "block", fontSize: 13, fontWeight: 700, marginBottom: 10, opacity: 0.7 }}>Sampling – nächstes Wort?</label>
        <SamplingViz
          distribution={step ? step.distribution : null}
          picked={step ? step.picked : null}
          context={step ? step.context : null}
          n={activeN} color={color}
          stepNum={vi >= 0 ? vi + 1 : 0}
          totalSteps={hist.length}
          onCandidateClick={handleCandidateClick}
        />
        {step && step.distribution && (
          <div style={{ fontSize: 11, opacity: 0.3, marginTop: 6 }}>Klick auf Kandidat zeigt N-Gramm oben</div>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<NGramApp />);
</script>
</body>
</html>
